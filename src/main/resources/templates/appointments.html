<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Appointments - HealSync</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        h2 {
            text-align: center;
            color: #333;
        }

        /* Summary Panel */
        .summary-panel {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .summary-card {
            background: #f8f9fa;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
        }

        .summary-card h4 {
            margin: 0 0 5px 0;
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
        }

        .summary-card span {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }

        /* Controls & Filters */
        .controls {
            text-align: center;
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            gap: 10px;
            align-items: center;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        select {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
            font-size: 14px;
        }

        button {
            padding: 10px 15px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
        }

        button:hover {
            background-color: #0056b3;
        }

        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        button.refresh-btn {
            background-color: #6c757d;
        }

        button.refresh-btn:hover {
            background-color: #5a6268;
        }

        /* Booking Form */
        .booking-section {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
            background: #f9f9f9;
        }

        .booking-section h3 {
            margin-top: 0;
            text-align: center;
            color: #555;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .form-group label {
            display: block;
            font-size: 12px;
            margin-bottom: 5px;
            font-weight: bold;
            color: #666;
        }

        .form-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .full-width {
            grid-column: span 2;
        }

        .book-btn {
            width: 100%;
            margin-top: 15px;
            background-color: #28a745;
            font-weight: bold;
        }

        .book-btn:hover {
            background-color: #218838;
        }

        /* Appointment Cards */
        .appointment-card {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 4px;
            background: #fff;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .appointment-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .appointment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-REQUESTED {
            background-color: #fd7e14;
            color: white;
        }

        .status-CONFIRMED {
            background-color: #28a745;
            color: white;
        }

        .status-CANCELLED {
            background-color: #dc3545;
            color: white;
        }

        .status-COMPLETED {
            background-color: #007bff;
            color: white;
        }

        .details {
            font-size: 14px;
            margin-bottom: 10px;
        }

        .notes-section {
            margin-top: 10px;
        }

        textarea {
            width: 100%;
            height: 60px;
            padding: 5px;
            margin-bottom: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .btn-cancel {
            background-color: #dc3545;
        }

        .btn-confirm {
            background-color: #28a745;
        }

        .btn-save {
            background-color: #17a2b8;
        }

        .btn-complete {
            background-color: #007bff;
        }

        .error {
            color: red;
            text-align: center;
            margin-top: 10px;
            font-weight: bold;
            padding: 10px;
            border-radius: 4px;
        }

        .success {
            color: green;
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            text-align: center;
            margin-top: 10px;
            font-weight: bold;
            padding: 10px;
            border-radius: 4px;
        }

        .loading {
            text-align: center;
            margin-top: 10px;
            font-style: italic;
            color: #666;
            display: none;
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .hidden {
            display: none;
        }

        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            min-width: 300px;
            text-align: center;
        }

        .modal-btn-group {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 15px;
        }
    </style>
</head>

<body>

    <div class="container">
        <h2>Manage Appointments</h2>

        <!-- Summary Panel -->
        <div class="summary-panel">
            <div class="summary-card">
                <h4>Total</h4>
                <span id="countTotal">0</span>
            </div>
            <div class="summary-card">
                <h4>Requested</h4>
                <span id="countRequested" style="color: #fd7e14;">0</span>
            </div>
            <div class="summary-card">
                <h4>Confirmed</h4>
                <span id="countConfirmed" style="color: #28a745;">0</span>
            </div>
            <div class="summary-card">
                <h4>Cancelled</h4>
                <span id="countCancelled" style="color: #dc3545;">0</span>
            </div>
            <div class="summary-card">
                <h4>Completed</h4>
                <span id="countCompleted" style="color: #007bff;">0</span>
            </div>
        </div>

        <!-- Booking Section -->
        <div class="booking-section">
            <h3>Book New Appointment</h3>
            <form id="bookingForm" onsubmit="bookAppointment(event)">
                <input type="hidden" id="doctorId">
                <input type="hidden" id="patientId">

                <div class="form-grid">

                    <div class="form-group">
                        <label>Reason:</label>
                        <input type="text" id="reason">
                    </div>
                    <div class="form-group">
                        <label>Start Time:</label>
                        <input type="datetime-local" id="start" required>
                    </div>
                    <div class="form-group">
                        <label>End Time:</label>
                        <input type="datetime-local" id="end" required>
                    </div>
                </div>
                <button type="submit" id="bookBtn" class="book-btn">Book Appointment</button>
            </form>
        </div>

        <!-- Filters & Refresh -->
        <div class="controls">
            <select id="statusFilter" onchange="loadAppointments()">
                <option value="">All Statuses</option>
                <option value="REQUESTED">Requested</option>
                <option value="CONFIRMED">Confirmed</option>
                <option value="CANCELLED">Cancelled</option>
                <option value="COMPLETED">Completed</option>
            </select>
            <button onclick="loadAppointments()">Load Appointments</button>
            <button onclick="loadConfirmedOnly()" style="background-color: #fd7e14;">Show Confirmed Only</button>
            <button class="refresh-btn" onclick="loadAppointments()">Refresh</button>
        </div>

        <!-- List -->
        <div id="loadingIndicator" class="loading">Loading appointments...</div>
        <div id="errorMessage" class="error"></div>

        <h3 style="border-bottom: 2px solid #007bff; padding-bottom: 5px; margin-top: 30px; color: #007bff;">Upcoming
            Appointments</h3>
        <div id="upcomingList"></div>

        <h3 style="border-bottom: 2px solid #6c757d; padding-bottom: 5px; margin-top: 30px; color: #6c757d;">Past
            Appointments</h3>
        <div id="pastList"></div>
    </div>

    <script>
        const API_BASE = '/api/appointments';

        function getAuthHeaders() {
            const token = localStorage.getItem('jwtToken');
            console.log('token:', token);

            if (!token) {
                console.log('No token');
                return {};
            }
            return {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            };
        }

        function showSuccess(msg) {
            const el = document.getElementById('errorMessage');
            el.className = 'success';
            el.innerText = msg;
            el.style.display = 'block';
            setTimeout(() => { el.style.display = 'none'; }, 5000);
        }

        function showError(msg) {
            const el = document.getElementById('errorMessage');
            el.className = 'error';
            el.innerText = msg;
            el.style.display = 'block';
        }

        async function bookAppointment(event) {
            event.preventDefault();

            const btn = document.getElementById('bookBtn');

            const startVal = document.getElementById('start').value;
            const endVal = document.getElementById('end').value;

            if (new Date(startVal) >= new Date(endVal)) {
                showError("Start time must be before end time");
                return;
            }

            const doctorIdInput = document.getElementById('doctorId').value;
            const doctorId = doctorIdInput ? Number(doctorIdInput) : 1;

            const patientId = document.getElementById('patientId').value;

            const payload = {
                clinicId: 1,
                doctorId: doctorId,
                patientId: Number(patientId),
                start: startVal + ":00",
                end: endVal + ":00",
                reason: document.getElementById('reason').value
            };

            console.log("Booking payload:", payload);

            try {

                btn.disabled = true;
                btn.textContent = "Creating appointment...";

                const response = await fetch(`${API_BASE}/book`, {
                    method: "POST",
                    headers: getAuthHeaders(),
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const err = await response.json().catch(() => ({}));
                    throw new Error(err.message || "Booking failed");
                }

                console.log("BOOK SUCCESS");

                showSuccess("Appointment booked successfully");

                document.getElementById("bookingForm").reset();

                await loadAppointments();

                document.getElementById("upcomingList")
                    .scrollIntoView({ behavior: "smooth" });

            } catch (error) {

                console.error(error);
                showError(error.message);

            } finally {

                btn.disabled = false;
                btn.textContent = "Book Appointment";
            }
        }

        async function loadAppointments() {
            console.log('appointments page loaded');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const errorMessage = document.getElementById('errorMessage');
            const statusFilter = document.getElementById('statusFilter').value;

            loadingIndicator.style.display = 'block';
            // errorMessage.innerText = ''; // Removed to persist success messages

            // Clear lists
            document.getElementById('upcomingList').innerHTML = '';
            document.getElementById('pastList').innerHTML = '';

            try {
                // First, get current user info
                const meResponse = await fetch('/api/auth/me', {
                    method: 'GET',
                    headers: getAuthHeaders()
                });

                if (!meResponse.ok) throw new Error('Failed to fetch user info. Please login again.');
                const user = await meResponse.json();
                console.log('current user:', user);

                // Auto-fill form fields based on role
                if (user.role === 'PATIENT') {
                    const pInput = document.getElementById('patientId');
                    if (pInput) {
                        pInput.value = user.userId;
                        pInput.disabled = true;
                    }
                } else if (user.role === 'DOCTOR') {
                    const dInput = document.getElementById('doctorId');
                    if (dInput) {
                        dInput.value = user.userId;
                        dInput.disabled = true;
                    }
                }

                let url = '';
                // Determine endpoints based on role
                if (user.role === 'DOCTOR') {
                    url = `${API_BASE}/doctor/${user.userId}`;
                } else if (user.role === 'PATIENT') {
                    url = `${API_BASE}/patient/${user.userId}`;
                } else {
                    if (user.role === 'ADMIN') {
                        throw new Error('Admin view not fully implemented for this page yet.');
                    }
                    throw new Error('Unknown role: ' + user.role);
                }

                // Append status filter if selected
                if (statusFilter) {
                    url += `?status=${statusFilter}`;
                }

                // Fetch appointments
                const response = await fetch(url, {
                    method: 'GET',
                    headers: getAuthHeaders()
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.message || 'Failed to load appointments');
                }

                const appointments = await response.json();

                // Calculate and update summary stats
                updateSummary(appointments);

                renderAppointments(appointments, user.role);

            } catch (error) {
                errorMessage.innerText = error.message;
            } finally {
                loadingIndicator.style.display = 'none';
            }
        }

        function updateSummary(appointments) {
            const counts = {
                total: appointments.length,
                requested: 0,
                confirmed: 0,
                cancelled: 0,
                completed: 0
            };

            appointments.forEach(app => {
                const status = app.status; // backend sends uppercase status
                if (status === 'REQUESTED') counts.requested++;
                else if (status === 'CONFIRMED') counts.confirmed++;
                else if (status === 'CANCELLED') counts.cancelled++;
                else if (status === 'COMPLETED') counts.completed++;
            });

            document.getElementById('countTotal').innerText = counts.total;
            document.getElementById('countRequested').innerText = counts.requested;
            document.getElementById('countConfirmed').innerText = counts.confirmed;
            document.getElementById('countCancelled').innerText = counts.cancelled;
            document.getElementById('countCompleted').innerText = counts.completed;
        }

        function renderAppointments(appointments, role) {
            const upcomingContainer = document.getElementById('upcomingList');
            const pastContainer = document.getElementById('pastList');

            upcomingContainer.innerHTML = '';
            pastContainer.innerHTML = '';

            const now = new Date();

            const upcoming = [];
            const past = [];

            appointments.forEach(app => {
                const start = new Date(app.startDateTime);
                if (start >= now) {
                    upcoming.push(app);
                } else {
                    past.push(app);
                }
            });

            // Helper to render a list into a container
            const renderList = (list, container, emptyMsg) => {
                if (list.length === 0) {
                    container.innerHTML = `
                        <div style="text-align:center;color:#777;padding:20px;background:#fff;border-radius:4px;border:1px dashed #ddd;">
                           ${emptyMsg}
                        </div>`;
                    return;
                }

                list.forEach(app => {
                    const card = document.createElement('div');
                    card.className = 'appointment-card';

                    const isDoctor = role === 'DOCTOR';

                    // Format dates
                    const startStr = app.startDateTime ? new Date(app.startDateTime).toLocaleString() : 'N/A';
                    const endStr = app.endDateTime ? new Date(app.endDateTime).toLocaleString() : 'N/A';

                    let actionsHtml = '';

                    // Doctor actions
                    if (isDoctor) {
                        if (app.status === 'REQUESTED') {
                            actionsHtml += `<button class="btn-confirm" onclick="confirmAppointment(${app.id})">Confirm</button>`;
                        } else if (app.status === 'CONFIRMED') {
                            actionsHtml += `<button class="btn-complete" onclick="completeAppointment(${app.id})">Complete</button>`;
                        }
                    }

                    // Common actions (only if not cancelled/completed)
                    if (app.status !== 'CANCELLED' && app.status !== 'COMPLETED') {
                        actionsHtml += `<button class="btn-cancel" onclick="cancelAppointment(${app.id})">Cancel</button>`;
                    }

                    // Notes section
                    let notesHtml = '';
                    if (isDoctor) {
                        notesHtml = `
                        <div class="notes-section">
                            <label>Doctor Notes:</label>
                            <textarea id="notes-${app.id}">${app.doctorNotes || ''}</textarea>
                            <button class="btn-save" onclick="saveNotes(${app.id})">Save Notes</button>
                        </div>
                     `;
                    } else {
                        notesHtml = `
                        <div class="notes-section">
                            <label>Doctor Notes:</label>
                            <div style="padding: 10px; background: #f1f1f1; border-radius: 4px; min-height: 40px; white-space: pre-wrap;">${app.doctorNotes || 'No notes available'}</div>
                        </div>
                     `;
                    }

                    const cancellationReason = app.status === 'CANCELLED' && app.cancellationReason
                        ? `<p style="color:red"><strong>Cancellation Reason:</strong> ${app.cancellationReason}</p>`
                        : '';

                    card.innerHTML = `
                    <div class="appointment-header">
                        <strong>ID: ${app.id}</strong>
                        <span class="status-badge status-${app.status}">${app.status}</span>
                    </div>
                    <div class="details">
                        <p><strong>Clinic ID:</strong> ${app.clinicId}</p>
                        <p><strong>Doctor:</strong> ${app.doctorName || app.doctorId}</p>
                        <p><strong>Patient:</strong> ${app.patientName || app.patientId}</p>
                        <hr style="border:0; border-top:1px solid #eee; margin:10px 0;">
                        <p><strong>Start:</strong> ${startStr}</p>
                        <p><strong>End:</strong> ${endStr}</p>
                        <p><strong>Reason:</strong> ${app.reason || 'N/A'}</p>
                        ${cancellationReason}
                    </div>
                    ${notesHtml}
                    <div class="actions">
                        ${actionsHtml}
                    </div>
                `;
                    container.appendChild(card);
                });
            };

            renderList(upcoming, upcomingContainer, "No upcoming appointments yet. Create one above ðŸ‘†");
            renderList(past, pastContainer, "No past appointments found.");
        }

        async function confirmAppointment(id) {
            if (!(await showConfirm('Are you sure you want to confirm this appointment?'))) return;

            try {
                const response = await fetch(`${API_BASE}/${id}/status`, {
                    method: 'PUT',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ status: 'CONFIRMED' })
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.message || 'Failed to confirm appointment');
                }

                showSuccess('Appointment confirmed successfully');
                loadAppointments();
            } catch (error) {
                showError(error.message);
            }
        }

        async function cancelAppointment(id) {
            const reason = prompt("Please enter cancellation reason:");
            if (!reason) return;

            try {
                const response = await fetch(`${API_BASE}/${id}/cancel`, {
                    method: 'PUT',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ reason: reason })
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.message || 'Failed to cancel appointment');
                }

                showSuccess('Appointment cancelled successfully');
                loadAppointments();
            } catch (error) {
                showError(error.message);
            }
        }

        async function saveNotes(id) {
            const notes = document.getElementById(`notes-${id}`).value;
            if (!notes) {
                showError("Notes cannot be empty");
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/${id}/notes`, {
                    method: 'PUT',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ doctorNotes: notes })
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.message || 'Failed to save notes');
                }

                showSuccess('Notes updated!');
                loadAppointments();
            } catch (error) {
                showError(error.message);
            }
        }

        async function completeAppointment(id) {
            if (!(await showConfirm("Mark appointment as completed?"))) return;

            try {
                const response = await fetch(`${API_BASE}/${id}/status`, {
                    method: 'PUT',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ status: 'COMPLETED' })
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.message || 'Failed to complete appointment');
                }

                showSuccess("Appointment completed");
                loadAppointments();
            } catch (error) {
                showError(error.message);
            }
        }

        async function loadConfirmedOnly() {
            try {
                const meResponse = await fetch('/api/auth/me', {
                    method: 'GET',
                    headers: getAuthHeaders()
                });

                if (!meResponse.ok) throw new Error("Failed to check user role");
                const user = await meResponse.json();

                if (user.role !== 'DOCTOR') {
                    showError("Only doctors can use this view");
                    return;
                }

                const response = await fetch(
                    `${API_BASE}/doctor/${user.userId}?status=CONFIRMED`,
                    {
                        method: 'GET',
                        headers: getAuthHeaders()
                    }
                );

                if (!response.ok) throw new Error("Failed to load confirmed appointments");
                const appointments = await response.json();

                updateSummary(appointments);
                renderAppointments(appointments, user.role);
                showSuccess(`Showing ${appointments.length} CONFIRMED appointments`);

            } catch (error) {
                showError(error.message);
            }
        }

        function showConfirm(message) {
            return new Promise((resolve) => {
                const modal = document.getElementById("confirmModal");
                const text = document.getElementById("confirmText");
                const yes = document.getElementById("confirmYes");
                const no = document.getElementById("confirmNo");

                text.innerText = message;
                modal.classList.remove("hidden");

                // Clear previous onClick handlers to prevent stacking? 
                // Setting onclick property overwrites previous handler, so it is safe.
                yes.onclick = () => {
                    modal.classList.add("hidden");
                    resolve(true);
                };

                no.onclick = () => {
                    modal.classList.add("hidden");
                    resolve(false);
                };
            });
        }

        // Auto-load on page load
        window.onload = loadAppointments;
    </script>

    <!-- Custom Confirm Modal -->
    <div id="confirmModal" class="modal hidden">
        <div class="modal-content">
            <p id="confirmText" style="font-size: 16px; margin-bottom: 20px; color: #333;"></p>
            <div class="modal-btn-group">
                <button id="confirmYes" class="btn-confirm" style="padding: 8px 20px; cursor: pointer;">Yes</button>
                <button id="confirmNo" class="refresh-btn" style="padding: 8px 20px; cursor: pointer;">Cancel</button>
            </div>
        </div>
    </div>

</body>

</html>